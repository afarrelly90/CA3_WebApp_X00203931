@page "/"
@inject NavigationManager Nav
@inject TVService TvService

<div class="main-container">

    <h3>Search for a TV show</h3>

    <MudTextField Label="Search for a TV Show"
                  @bind-Value="q"
                  Variant="Variant.Filled"
                  Class="mb-2" />

    <div class="filter-panel">
        <MudGrid Class="filter-grid">
            <MudItem xs="8" sm="6" md="4">
                <MudNumericField T="int?"
                    Label="Minimum Rating"
                    Variant="Variant.Outlined"
                    @bind-Value="minRating"
                    Min="0"
                    Max="10"
                    Immediate="true"
                    Class="mb-3" />
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudSelect T="ShowStatus"
                           Label="Show Status"
                           Variant="Variant.Outlined"
                           @bind-Value="selectedStatus">
                    <MudSelectItem Value="ShowStatus.All">All</MudSelectItem>
                    <MudSelectItem Value="ShowStatus.Running">Running</MudSelectItem>
                    <MudSelectItem Value="ShowStatus.Ended">Ended</MudSelectItem>
                    <MudSelectItem Value="ShowStatus.ToBeDetermined">To Be Determined</MudSelectItem>

                </MudSelect>
            </MudItem>
        </MudGrid>
    </div>
    <MudButton Color="Color.Primary"
               Variant="Variant.Filled"
               OnClick="Search">
        Search
    </MudButton>
    <MudDivider Class="my-3" />

    @if (isLoading)
    {
        <MudText Typo="Typo.h6">Loading...</MudText>
    }

    @if (!string.IsNullOrEmpty(errorMsg))
    {
        <MudAlert Severity="Severity.Warning" Elevation="0" Class="mt-2">
            @errorMsg
        </MudAlert>
    }


    @if (filteredResults != null)
    {
        if (filteredResults.Count == 0)
        {
            <MudText Typo="Typo.h6" Class="text-muted mt-3">
                No results found — try a different search or adjust your filters.
            </MudText>
        }
        else
        {
            <MudGrid Class="mt-3">
                @foreach (var r in filteredResults)
                {
                    var id = r.Show?.Id;
                    var src = r.Show?.Image?.Original ?? r.Show?.Image?.Medium ?? "images/placeholder.jpg";
                    var rawRating = r.Show?.Rating?.Average;
                    var hasRating = rawRating.HasValue && rawRating.Value >= 0.5;

                    var rating = hasRating ? rawRating.Value.ToString("0.0") : "N/A";
                    var stars = hasRating ? (int)(rawRating.Value / 2) : 0;

                    var name = r.Show?.Name ?? "Unknown";
                    var premiered = r.Show?.Premiered != null ? DateTime.Parse(r.Show.Premiered).Year.ToString(): "?";
                    var ended = r.Show?.Ended != null ? DateTime.Parse(r.Show.Ended).Year.ToString(): null;
                    var yearsAired = ended == null ? $"{premiered}–" : $"{premiered}–{ended}";

                    var status = r.Show?.Status ?? "Unknown";
                    <MudItem xs="12" sm="6" md="3">
                        <MudCard Class="show-card"
                                 Style="cursor:pointer;"
                                 @onclick="() => GoToShow(id)">

                            <div class="image-container">
                                <img src="@src" alt="@name" class="show-image" />
                            </div>
                            <MudCardContent class="card-body">
                                <MudStack Direction="Column" Spacing="1">
                                    <MudText Typo="Typo.subtitle2" Class="show-title">
                                        @name (@yearsAired)
                                    </MudText>

                                    <div class="rating-line">
                                        <MudRating SelectedValue="@stars"
                                                   MaxValue="5"
                                                   ReadOnly="true"
                                                   Size="Size.Small"
                                                   Class="static-rating" />

                                        <span class="rating-number">(@rating)</span>
                                    </div>
                                    <MudChip T="string"
                                             Color="@GetStatusColor(status)"
                                             Variant="Variant.Filled"
                                             Size="Size.Small">
                                        @status
                                    </MudChip>

                                </MudStack>
                            </MudCardContent>

                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        }
    }
</div>

@code {
    [Parameter, SupplyParameterFromQuery] public string? q { get; set; }
    [Parameter, SupplyParameterFromQuery] public int? r { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? s { get; set; }

    bool isLoading = false;
    string? errorMsg = null;

    int? minRating = null;
    ShowStatus selectedStatus = ShowStatus.All;

    List<SearchResult>? results;
    List<SearchResult>? filteredResults;

    void Search()
    {
        errorMsg = null;
        var url = $"?q={q}&r={minRating}&s={selectedStatus}";
        Nav.NavigateTo(url);
    }

    void ApplyFilters()
    {
        if (results == null)
            return;

        filteredResults = results;
        if (minRating.HasValue)
        {
            filteredResults = filteredResults
                .Where(r => r.Show?.Rating?.Average >= minRating.Value)
                .ToList();
        }

        if (selectedStatus != ShowStatus.All)
        {
            var statusString = selectedStatus.ToString().Replace("_", " ");
            filteredResults = filteredResults
                .Where(r => string.Equals(r.Show?.Status, statusString, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
    }
    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrWhiteSpace(q))
        {
            isLoading = true;
            results = await TvService.SearchShowsAsync(q);

            if (r.HasValue && (r.Value < 0 || r.Value > 10))
            {
                errorMsg = "Minimum rating must be between 0 and 10.";
                minRating = null;
            }
            else
            {
                minRating = r;
            }

            if (!string.IsNullOrWhiteSpace(s))
            {
                ShowStatus parsedStatus;
                if (Enum.TryParse(s, out parsedStatus))
                {
                    selectedStatus = parsedStatus;
                }
                else
                {
                    errorMsg = "Invalid status filter — reset to 'All'.";
                    selectedStatus = ShowStatus.All;
                }
            }
            else
            {
                selectedStatus = ShowStatus.All;
            }

            ApplyFilters();
            isLoading = false;
        }
        else
        {
            results = null;
            filteredResults = null;
            errorMsg = null;
            if (q != null && string.IsNullOrWhiteSpace(q))
            {
                errorMsg = "Please enter something to search.";
            }
            else
            {
                errorMsg = null;
            }


        }

    }


    void GoToShow(int? id)
    {
        if (id.HasValue)
            Nav.NavigateTo($"show/{id.Value}");
    }

    Color GetStatusColor(string status) =>
        status switch
        {
            "Running"=> Color.Success,
            "Ended" => Color.Error,
            "To Be Determined" => Color.Warning,
            _ => Color.Info
        };
}
